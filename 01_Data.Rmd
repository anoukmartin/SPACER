---
title: "01_Data. Import, filtrage, enrichissement, exploration"
author: "R. Leconte"
date: "07/01/2024"
output: html_document
---

Données:

Résultats des élections présidentielles 1er tour
Millésime 2022
Echellon communal

https://www.data.gouv.fr/fr/datasets/election-presidentielle-des-10-et-24-avril-2022-resultats-definitifs-du-1er-tour/#/resources

Objectifs: 

- importer les données
- filtrage géographique des données
- mise en forme des données
- enrichissement des données
- exploration des données


```{r pkg_wd}

#install.packages("openxlsx")
library(openxlsx)
library(dplyr)


```

# 1. Préparation des données
## 1.1. Chargement

```{r data}

dataURL <- "https://www.data.gouv.fr/fr/datasets/r/6d9b33e5-667d-4c3e-9a0b-5fdf5baac708"
elec <- read.xlsx(dataURL,sheet=1)

# On recréer des nom de variables explicites
vars_candidats <- c("N°Panneau", "Sexe", "Nom", "Prénom", "Voix", "%.Voix/Ins", "%.Voix/Exp")
candidats <- c("ARTHAUD", "ROUSSEL", "MACRON", "LASSALLE", "LE_PEN", "ZEMMOUR", "MELENCHON", "HIDALGO", "JADOT", "PECRESSE", "POUTOU", "DUPONT-AIGNAN")

names_corr <- lapply(candidats, 
                     function(x){
                       paste0(x, "_", vars_candidats)
                       })
names_corr <- unlist(names_corr)

# On définit les noms de variables pour toutes la base de données
names(elec)
names_new <- c(names(elec)[1:19], names_corr)
names(elec) <- names_new
```


## 1.2. Filtrage géographique (sélection des individus)

```{r data_geofilter}

elec_paca <- elec %>% 
  filter(Code.du.département %in% c("04", "05", "06", "13", "83", "84"))


```


# 2. Enrichissement des données

```{r data_join}

## On crée un code unique par commune ----

elec_paca$ident_commune <- paste0(elec_paca$Code.du.département, elec_paca$Code.de.la.commune)

# Données socio-démo ###########################################################

## Import des données ----
library(readr)
soc_dem <- read_csv2("socdem.csv", trim_ws = TRUE,
                     col_types = cols(voiture = col_double()))

## On ajoute un "0" devant certains codes communes parce disparu à l'export ----
library(stringr)
soc_dem <- soc_dem %>%
  mutate(Code = as.character(Code)) %>%
  mutate(Code = if_else(str_length(Code) == 4, 
                        paste0("0", Code), 
                        Code))

## On ajoute ces données socio-démo aux données éléctorales ----
elec_paca <- left_join(elec_paca, soc_dem, by = c("ident_commune" = "Code"))


# Données revenu ###########################################################

## Import des données ----
revenu <- read_csv2("FILO2018_DISP_COM.csv", trim_ws = TRUE)

## Filtre par département ----
revenu <- revenu %>%
  mutate(DEPT = substr(CODGEO, 1, 2))

revenu <- revenu %>%
  filter(DEPT %in% c("04", "05", "06", "13", "83", "84"))

## On ne garde que la colonne qui nous intéresse et on la renomme ----
revenu <- revenu %>%
  select(CODGEO, Q218)

names(revenu)[names(revenu)=="Q218"] <- "med_rev"

## On ajoute aux données éléctroales ----
elec_paca <- left_join(elec_paca, revenu, by = c("ident_commune" = "CODGEO"))

library(questionr)
freq(is.na(elec_paca$med_rev))
# 834 réponses ce qui semble correct


# Données taux de pauvreté ######################################################

## Import des données ----
pauvres <- read_csv2("FILO2018_DISP_Pauvres_COM.csv", trim_ws = TRUE)

## Filtre par département ----
pauvres <- pauvres %>%
  mutate(DEPT = substr(CODGEO, 1, 2))

pauvres <- pauvres %>%
  filter(DEPT %in% c("04", "05", "06", "13", "83", "84"))

## On ne garde que la colonne qui nous intéresse ----
pauvres <- pauvres %>%
  select(CODGEO, TP6018)

names(pauvres)[names(pauvres)=="TP6018"] <- "taux_pauvrete_60"

## On ajoute aux données éléctroales ----
elec_paca <- left_join(elec_paca, pauvres, by = c("ident_commune" = "CODGEO"))

freq(is.na(elec_paca$taux_pauvrete_60))
# Attention seulement 309 réponses


```




# 2. Exploration statistique et graphique

Quelques fonctions utiles 

```{r explor}

# Contrôler la présence de valeurs manquantes dans une variable
table(is.na(elec_soc_idf$Population.de.15.ans.ou...selon.la.CSP.2020))

# Connaitre le résumé statistique

summary(elec_soc_idf$ART_V_E)


# Observer la distribution d'une variable
# Courbe de densité
ggplot(elec_soc_idf, aes(x=ART_V_E)) + 
  geom_density()+
   scale_y_continuous(labels = scales::comma)+ # se débarasser de la notation scientifique
  # Habiller le graphique
      ylab("Densité de probabilité")+
  xlab("Part des votes exprimés ")+
  ggtitle("Résultats électoraux de N. Artaud en 2022 par commune en Ile de France")


# Boîte à moustache
ggplot(elec_soc_idf, aes(x = ART_V_E))+
  geom_boxplot()


# Graphique rang-taille

ggplot(elec_soc_idf, aes(x= reorder(Code, -ART_V_E), y = ART_V_E))+
  geom_point()+
  scale_y_log10("Votes exprimés N. Artaud", labels = scales:: comma)+
  scale_x_discrete("Rang", labels= NULL)
  



```





